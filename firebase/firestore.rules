rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Users ──────────────────────────────────────────────
    match /users/{userId} {
      // Users can read their own document; admins can read other users in same org
      allow read: if request.auth != null
        && (request.auth.uid == userId
            || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
                && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == resource.data.organizationId));
      allow write: if request.auth != null && request.auth.uid == userId;

      // Custom CPT codes
      match /customCodes/{codeId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // ICD-10 usage tracking
      match /icd10Usage/{code} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // User settings (code groups, preferences)
      match /settings/{settingId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Cath cases (user's own)
      match /cathCases/{caseId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;

        match /codes/{codeId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }

    // ── Invite Codes (top-level for O(1) lookup) ──────────
    match /inviteCodes/{code} {
      // Any authenticated user can read (to validate during registration)
      allow read: if request.auth != null;
      // Only admins can create invite codes
      allow create: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == request.resource.data.organizationId;
      // Any authenticated user can update (for redemption)
      allow update: if request.auth != null;
    }

    // ── Organizations ──────────────────────────────────────
    match /organizations/{orgId} {
      // Any authenticated user can read orgs (for practice code lookup)
      allow read: if request.auth != null;
      // Only admins of the org can write
      allow write: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Hospitals
      match /hospitals/{hospitalId} {
        allow read: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
        allow write: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }

      // Cath Labs
      match /cathLabs/{cathLabId} {
        allow read: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
        allow write: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }

      // Inpatients (shared across org physicians)
      match /inpatients/{inpatientId} {
        allow read: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
        allow create: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
        allow update: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;

        // Diagnoses
        match /diagnoses/{diagnosisId} {
          allow read, write: if request.auth != null
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
        }

        // Charges
        match /charges/{chargeId} {
          allow read: if request.auth != null
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
          allow create, update: if request.auth != null
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
          // Only admins can delete charges
          allow delete: if request.auth != null
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

          match /codes/{codeId} {
            allow read, write: if request.auth != null
              && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
          }

          match /chargeDiagnoses/{diagId} {
            allow read, write: if request.auth != null
              && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
          }
        }
      }

      // Call list entries
      match /callListEntries/{entryId} {
        allow read: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
        allow create: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
        allow update: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
      }

      // Invites (admin management — mirrored from top-level inviteCodes)
      match /invites/{inviteId} {
        allow read: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
        allow create, update: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }

      // Organization settings (report schedule, etc.)
      match /settings/{settingId} {
        allow read: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
        allow write: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }

      // Audit log — IMMUTABLE: create-only, no update or delete (HIPAA requirement)
      match /auditLog/{logId} {
        allow read: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
        allow create: if request.auth != null
          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organizationId == orgId;
        // update and delete intentionally omitted — audit entries must be immutable
      }
    }
  }
}
